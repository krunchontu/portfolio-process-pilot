# <!-- Powered by BMADT Core -->

# Story 4.5: Backend Coverage Gate in CI

## Status
Draft

## Story
**As a** team maintaining code quality,
**I want** CI to enforce minimum backend test coverage thresholds,
**So that** regressions are caught early and test quality improves incrementally without blocking momentum.

## Acceptance Criteria
1. CI enforces Jest coverage thresholds for the backend and fails the pipeline when coverage drops below configured limits.
2. Thresholds are conservative and aligned with current baseline, with targeted higher bars for critical areas (e.g., `middleware/`, `utils/`).
3. Coverage summary appears in CI logs, and artifacts are uploaded for inspection: `backend/coverage/lcov.info` and HTML report under `backend/coverage/lcov-report/**`.
4. Local developer workflow is documented to run coverage and interpret failures (`npm run test:coverage`).
5. Configuration avoids flakiness: excludes E2E/Playwright and focuses on backend Jest suites; respects OS differences.

## Tasks / Subtasks
- [ ] Establish baseline (AC: 2, 4)
  - [ ] Run `cd backend && npm run test:coverage` locally to capture current line/branch/function coverage
  - [ ] Note coverage for overall and for `src/middleware/**` and `src/utils/**`
- [ ] Configure thresholds (AC: 1–2)
  - [ ] Add `coverageThreshold` to `backend/jest.config.js` with:
        - Overall line coverage at or slightly below baseline (e.g., baseline minus 2%)
        - Per-path thresholds: `src/middleware/**` and `src/utils/**` lines >= 60% (tune to pass current baseline)
  - [ ] Ensure Windows paths are handled correctly
- [ ] CI integration (AC: 1, 3, 5)
  - [ ] Update `.github/workflows/backend-ci.yml` to run `npm run test:coverage`
  - [ ] Upload coverage artifacts (`coverage/lcov.info` and HTML if generated)
  - [ ] Print summarized coverage to the job output
- [ ] Documentation (AC: 4)
  - [ ] Add a short section to `backend/TESTING.md` and/or README on coverage gates, how to run locally, and how to address failures
  - [ ] Describe policy for gradually raising thresholds as coverage improves
- [ ] Verification (AC: 1–5)
  - [ ] Open a PR with the CI and Jest config changes; confirm CI passes
  - [ ] Create a throwaway commit lowering a threshold to ensure CI fails, then revert

## Dev Notes

### Relevant Project Files
- Backend config and scripts
  - `backend/jest.config.js` — add `coverageThreshold`
  - `backend/package.json` — `test:coverage` script already present
  - `.github/workflows/backend-ci.yml` — integrate coverage run + artifact upload
  - `backend/TESTING.md` — add coverage gate documentation

### Architecture & Standards References
- [Source: docs/architecture/coding-standards.md]
- [Source: docs/DEVELOPMENT_SETUP.md]
- [Source: backend/TESTING.md]

### Technical Considerations
- Keep thresholds realistic to avoid blocking dev flow; ratchet up over time.
- Prefer per-path thresholds for critical code over a high global threshold.
- CI environment has restricted network; coverage generation does not require network.

## Change Log
| Date       | Version | Description                           | Author            |
|------------|---------|---------------------------------------|-------------------|
| 2025-09-14 | 1.0     | Initial draft of Story 4.5            | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
N/A (Story draft)

### Debug Log References
- Planned: CI job coverage summary and uploaded artifacts
